@model CO.CDP.ApplicationRegistry.App.Models.ApplicationsViewModel
@{
    ViewData["Title"] = "Available applications";
    var organisationSlug = ViewContext.RouteData.Values["organisationSlug"]?.ToString() ?? "";
}

@section BeforeContent {
    <a href="/organisation/@organisationSlug" class="govuk-back-link">Back</a>
}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <span class="govuk-caption-xl">@Model.OrganisationName</span>
        <h1 class="govuk-heading-xl">Available applications</h1>
        <p class="govuk-body-l">Enable applications for your organisation to allow users to be assigned access.</p>
    </div>
</div>

<form method="get" aria-label="Search and filter applications" class="app-filter-container">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-quarter">
            <div class="govuk-form-group filter-dropdown-wrapper">
                <label class="govuk-label govuk-!-font-weight-bold" for="category-filter">
                    Filter by category
                </label>
                <select class="govuk-select" id="category-filter" name="category">
                    <option value="">All categories</option>
                    @foreach (var cat in Model.Categories)
                    {
                        <option value="@cat" selected="@(cat == Model.SelectedCategory)">@cat</option>
                    }
                </select>
            </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
            <div class="govuk-form-group filter-dropdown-wrapper">
                <label class="govuk-label govuk-!-font-weight-bold" for="status-filter">
                    Filter by status
                </label>
                <select class="govuk-select" id="status-filter" name="status">
                    <option value="">All statuses</option>
                    <option value="enabled" selected="@(Model.SelectedStatus == "enabled")">Enabled</option>
                    <option value="available" selected="@(Model.SelectedStatus == "available")">Available to enable</option>
                </select>
            </div>
        </div>
        <div class="govuk-grid-column-one-half">
            <div class="govuk-form-group">
                <label class="govuk-label govuk-!-font-weight-bold" for="application-search">
                    Search applications
                </label>
                <div class="search-flex-display">
                    <input class="govuk-input search-text-input"
                           id="application-search"
                           name="search"
                           type="text"
                           value="@Model.SearchTerm"
                           placeholder="e.g. registration">

                    <button type="submit" class="govuk-button search-button govuk-!-width-auto" data-module="govuk-button" id="search-button">
                        <span class="govuk-visually-hidden">Search</span>
                        <svg class="gem-c-search__icon" width="18" height="18" viewBox="0 0 27 27" fill="none"
                             xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <circle cx="12.0161" cy="11.0161" r="8.51613" stroke="currentColor" stroke-width="3"></circle>
                            <line x1="17.8668" y1="17.3587" x2="26.4475" y2="25.9393" stroke="currentColor"
                                  stroke-width="3"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

@if (Model.TotalCount == 0)
{
    <div class="govuk-inset-text">
        <p>No applications found.</p>
        <p>Try:</p>
        <ul class="govuk-list govuk-list--bullet">
            <li>checking your spelling</li>
            <li>using different search terms</li>
            @if (!string.IsNullOrEmpty(Model.SelectedCategory) || !string.IsNullOrEmpty(Model.SelectedStatus))
            {
                <li><a href="?organisationSlug=@organisationSlug" class="govuk-link">clearing the filters</a></li>
            }
        </ul>
    </div>
}
else
{
    <p class="govuk-body">Showing @Model.TotalCount applications</p>

    @if (Model.EnabledApplications.Count > 0)
    {
        <h2 class="govuk-heading-l govuk-!-margin-top-8">Enabled applications</h2>
        
        @foreach (var app in Model.EnabledApplications)
        {
            <div class="govuk-summary-card govuk-!-margin-bottom-6">
                <div class="govuk-summary-card__title-wrapper">
                    <h3 class="govuk-summary-card__title">
                        <a href="/organisation/@organisationSlug/applications/@app.Id" class="govuk-link">@app.Name</a>
                    </h3>
                    <ul class="govuk-summary-card__actions">
                        <li class="govuk-summary-card__action">
                            <strong class="govuk-tag govuk-tag--green">Enabled</strong>
                        </li>
                    </ul>
                </div>
                <div class="govuk-summary-card__content">
                    @if (!string.IsNullOrEmpty(app.Description))
                    {
                        <p class="govuk-body">@app.Description</p>
                    }
                    <dl class="govuk-summary-list govuk-summary-list--no-border">
                        @if (!string.IsNullOrEmpty(app.Category))
                        {
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">Category</dt>
                                <dd class="govuk-summary-list__value">@app.Category</dd>
                            </div>
                        }
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">Users assigned</dt>
                            <dd class="govuk-summary-list__value">@app.UsersAssigned</dd>
                        </div>
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">Roles available</dt>
                            <dd class="govuk-summary-list__value">@app.RolesAvailable</dd>
                        </div>
                    </dl>
                    <p class="govuk-body">
                        <a href="/organisation/@organisationSlug/applications/@app.Id/users" class="govuk-link govuk-!-margin-right-4">Manage user access</a>
                        <a href="/organisation/@organisationSlug/applications/@app.Id" class="govuk-link">View details</a>
                    </p>
                </div>
            </div>
        }
    }

    @if (Model.AvailableApplications.Count > 0)
    {
        <h2 class="govuk-heading-l govuk-!-margin-top-8">Available to enable</h2>
        
        @foreach (var app in Model.AvailableApplications)
        {
            <div class="govuk-summary-card govuk-!-margin-bottom-6">
                <div class="govuk-summary-card__title-wrapper">
                    <h3 class="govuk-summary-card__title">
                        <a href="/organisation/@organisationSlug/applications/@app.Id" class="govuk-link">@app.Name</a>
                    </h3>
                    <ul class="govuk-summary-card__actions">
                        <li class="govuk-summary-card__action">
                            <strong class="govuk-tag govuk-tag--grey">Not enabled</strong>
                        </li>
                    </ul>
                </div>
                <div class="govuk-summary-card__content">
                    @if (!string.IsNullOrEmpty(app.Description))
                    {
                        <p class="govuk-body">@app.Description</p>
                    }
                    <dl class="govuk-summary-list govuk-summary-list--no-border">
                        @if (!string.IsNullOrEmpty(app.Category))
                        {
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">Category</dt>
                                <dd class="govuk-summary-list__value">@app.Category</dd>
                            </div>
                        }
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">Roles available</dt>
                            <dd class="govuk-summary-list__value">@app.RolesAvailable</dd>
                        </div>
                    </dl>
                    <p class="govuk-body">
                        <a href="/organisation/@organisationSlug/applications/@app.Id/enable" class="govuk-button govuk-button--secondary" data-module="govuk-button">Enable for your organisation</a>
                        <a href="/organisation/@organisationSlug/applications/@app.Id" class="govuk-link govuk-!-margin-left-4">View details</a>
                    </p>
                </div>
            </div>
        }
    }
}

@section Scripts {
    <script nonce-csp>
        document.addEventListener('DOMContentLoaded', function() {
            const categoryFilter = document.getElementById('category-filter');
            const statusFilter = document.getElementById('status-filter');
            const form = document.querySelector('.app-filter-container');

            function submitOnChange() {
                form.submit();
            }

            if (categoryFilter) categoryFilter.addEventListener('change', submitOnChange);
            if (statusFilter) statusFilter.addEventListener('change', submitOnChange);
        });
    </script>
}