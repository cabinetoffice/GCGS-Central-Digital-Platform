@using CO.CDP.RegisterOfCommercialTools.App.Models
@{
    var locationSelection = ViewData["LocationSelection"] as LocationCodeSelection ?? new LocationCodeSelection();
    var selectorOptions = new HierarchicalCodeSelectorOptions
    {
        CodeType = "Location",
        ModalTitle = "Select contract locations",
        SearchPlaceholder = "e.g. London or UK",
        RoutePrefix = "location",
        FieldName = "location",
        BrowseButtonId = "browse-location-codes",
        ModalId = "location-selector-modal",
        SearchInputId = "location-search",
        TreeContainerId = "location-tree",
        SearchContainerId = "location-search-results-list",
        SelectionContainerId = "location-selected-codes-list",
        AccordionContentId = "contract-location-content"
    };
}

<div class="govuk-!-margin-top-0" id="contract-location-content">
    @if (locationSelection.HasSelections)
    {
        <div class="govuk-!-margin-bottom-3 govuk-!-padding-left-2">
            <p class="govuk-body-s govuk-!-font-weight-bold">@locationSelection.SelectionSummary:</p>
            <div class="govuk-!-margin-top-2">
                @foreach (var selectedItem in locationSelection.SelectedItems.OrderBy(x => x.GetDescription()))
                {
                    var isCountryLevel = string.IsNullOrEmpty(selectedItem.ParentCode);

                    <div class="govuk-tag govuk-tag--grey govuk-!-margin-right-1 govuk-!-margin-bottom-1 location-filter-tag"
                         data-code="@selectedItem.Code">
                        <div class="govuk-!-font-weight-bold">@selectedItem.GetDescription()</div>
                        @if (!isCountryLevel && !string.IsNullOrEmpty(selectedItem.ParentCode))
                        {
                            <div class="govuk-hint govuk-!-font-size-14 location-parent-info">
                                @{
                                    var parentName = selectedItem.ParentCode switch
                                    {
                                        "UK" => "United Kingdom",
                                        "ROW" => "Rest of the World",
                                        "BOT" => "British Overseas Territories",
                                        "GG" => "Guernsey",
                                        "IM" => "Isle of Man",
                                        "JE" => "Jersey",
                                        _ => selectedItem.ParentCode
                                    };
                                }
                                @parentName
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <div class="accordion-highlight govuk-!-padding-2 govuk-!-margin-left-2 govuk-!-margin-right-4">
        <a href="#" class="govuk-link" id="@selectorOptions.BrowseButtonId">
            @locationSelection.BrowseLinkText
        </a>
    </div>

    @foreach (var (name, value) in locationSelection.GetHiddenInputs())
    {
        <input type="hidden" name="@name" value="@value" />
    }
</div>

<partial name="_HierarchicalCodeSelector" model="(selectorOptions, (IHierarchicalCodeSelection)locationSelection)" />

<script src="~/js/location-selector.js" nonce-csp></script>
<script nonce-csp>
document.addEventListener("DOMContentLoaded", function () {
    if (typeof LocationSelector !== 'undefined') {
        LocationSelector.init({
            codeType: '@selectorOptions.CodeType',
            routePrefix: '@selectorOptions.RoutePrefix',
            fieldName: '@selectorOptions.FieldName',
            modalId: '@selectorOptions.ModalId',
            triggerId: '@selectorOptions.BrowseButtonId',
            searchInputId: '@selectorOptions.SearchInputId',
            treeContainerId: '@selectorOptions.TreeContainerId',
            searchContainerId: '@selectorOptions.SearchContainerId',
            selectionContainerId: '@selectorOptions.SelectionContainerId',
            accordionContentId: '@selectorOptions.AccordionContentId'
        });
    }

});
</script>