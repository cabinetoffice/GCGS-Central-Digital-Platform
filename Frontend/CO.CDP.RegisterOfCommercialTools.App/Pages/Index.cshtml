@page "/"
@using CO.CDP.RegisterOfCommercialTools.App.Models
@model IndexModel
@{
    ViewData["Title"] = "Search results";
    var commercialToolAccordion = new Accordion(
        "commercial-tool",
        "Commercial tool",
        "_CommercialToolAccordionContent", Model.SearchParams
    ) { IsOpen = true };
    var commercialToolStatusAccordion = new Accordion(
        "commercial-tool-status",
        "Commercial tool status",
        "_CommercialToolStatusAccordionContent", Model.SearchParams
    ) { IsOpen = true };
    var contractingAuthorityUsageAccordion = new Accordion(
        "contracting-authority-usage",
        "Contracting authority usage",
        "_ContractingAuthorityUsageAccordionContent", Model.SearchParams
    ) { IsOpen = true };
    var awardMethodAccordion = new Accordion(
        "award-method",
        "Award method",
        "_AwardMethodAccordionContent", Model.SearchParams
    ) { IsOpen = true };
    var industryCpvCodeAccordion = new Accordion(
        "industry-cpv-code",
        "CPV code",
        "_IndustryCpvCodeAccordionContent", Model
        ) { IsOpen = true };
    var contractLocationAccordion = new Accordion(
        "contract-location",
        "Contract location",
        "_ContractLocationAccordionContent", Model
    ) { IsOpen = true };
    var feesAccordion = new Accordion(
        "fees",
        "Fees",
        "_FeesAccordionContent", Model.SearchParams
    ) { IsOpen = true };
    var dateRangeAccordion = new Accordion(
        "date-range",
        "Date range",
        "_DateRangeAccordionContent", Model.SearchParams
    ) { IsOpen = true };
}

<script src="/js/search.js" nonce-csp></script>
<script nonce-csp>
document.addEventListener('DOMContentLoaded', function() {
    const resetButton = document.getElementById('reset-filters');
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            sessionStorage.removeItem('cpv-selected-codes');
            sessionStorage.removeItem('cpv-location-names');

            sessionStorage.removeItem('location-selected-codes');
            sessionStorage.removeItem('location-location-names');
        });
    }
});
</script>



@section BeforeContent {
    <govuk-breadcrumbs>
        <govuk-breadcrumbs-item href="@Model.HomeUrl">Home</govuk-breadcrumbs-item>
        <govuk-breadcrumbs-item>Search results</govuk-breadcrumbs-item>
    </govuk-breadcrumbs>

    <govuk-inset-text>The Register of Commercial Tools allows you to search for frameworks and dynamic markets.
    </govuk-inset-text>
}

    <div class="govuk-grid-row">
        @if (!ModelState.IsValid)
        {
            <div class="govuk-error-summary" data-module="govuk-error-summary">
                <div role="alert">
                    <h2 class="govuk-error-summary__title">
                        There is a problem
                    </h2>
                    <div class="govuk-error-summary__body">
                        <ul class="govuk-list govuk-error-summary__list">
                            @{
                                var seenMessages = new HashSet<string>();

                                var uniqueErrors = ModelState
                                    .SelectMany(kvp => kvp.Value?.Errors
                                        .Where(error => !string.IsNullOrEmpty(error.ErrorMessage) && seenMessages.Add(error.ErrorMessage))
                                        .Select(error => (kvp.Key, Message: error.ErrorMessage)) ?? Enumerable.Empty<(string Key, string Message)>())
                                    .OrderBy(e => e.Message)
                                    .ToList();
                            }
                            @foreach (var error in uniqueErrors)
                            {
                                <li><a href="#@error.Key">@error.Message</a></li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="govuk-grid-row govuk-!-margin-bottom-4">
        <div class="govuk-grid-column-one-half">
            <h1 class="govuk-heading-l govuk-!-margin-bottom-2">Search results</h1>
            <p class="govuk-body-m govuk-!-margin-bottom-0">We've found <span class="govuk-!-font-weight-bold">@Model.TotalCount</span>
                result@(Model.TotalCount == 1 ? "" : "s")</p>
        </div>
        <div class="govuk-grid-column-one-half">
            <div class="govuk-!-text-align-right">
                <label for="sort-results" class="govuk-label govuk-!-font-weight-bold govuk-!-display-block">Sort results</label>
                <div>
                    <select id="sort-results" class="govuk-select" name="sort" asp-for="SearchParams.SortOrder" form="search-form">
                        <option value="relevance">Relevance</option>
                        <option value="a-z">Alphabetical (A-Z)</option>
                        <option value="z-a">Alphabetical (Z-A)</option>
                    </select>
                    <noscript>
                        <button type="submit" class="govuk-button govuk-!-margin-left-2" form="search-form">Sort</button>
                    </noscript>
                </div>
            </div>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-third">
            <form method="get" id="search-form">
                <div class="govuk-!-padding-2 govuk-!-padding-bottom-6 govuk-!-margin-bottom-5 govuk-filter-section">
                    <h2 class="govuk-heading-m govuk-!-margin-bottom-2">Keywords</h2>

                    <p class="govuk-body-s govuk-!-margin-bottom-3">
                        Search titles, descriptions, identifiers and organisation names
                    </p>

                    <details class="govuk-details small-details govuk-!-margin-right-2" data-module="govuk-details">
                        <summary class="govuk-details__summary">
                            <span class="govuk-details__summary-text govuk-!-font-size-16">
                                Help with keyword search
                            </span>
                        </summary>
                        <div class="govuk-details__text">
                            <ul class="govuk-list govuk-list--bullet govuk-body-s">
                                <li>
                                    To search for <span class="govuk-!-font-weight-bold">any</span> word, put a <span
                                        class="govuk-!-font-weight-bold">space</span> between words.
                                    For example, <span class="govuk-!-font-weight-bold">radio televisions</span>
                                </li>
                                <li>
                                    To search for <span class="govuk-!-font-weight-bold">all</span> words, put a +
                                    between words.
                                    For example, <span class="govuk-!-font-weight-bold">administration + defence</span>
                                </li>
                                <li>
                                    To search for an <span class="govuk-!-font-weight-bold">exact</span> phrase, use
                                    <span class="govuk-!-font-weight-bold">quotes</span>.
                                    For example, <span class="govuk-!-font-weight-bold">"market research"</span>
                                </li>
                            </ul>
                        </div>
                    </details>

                    <input id="Keywords" name="q" type="text" asp-for="SearchParams.Keywords"
                           class="govuk-input">
                </div>

                <div>
                    <partial name="_Accordion" model="commercialToolAccordion"/>
                    <partial name="_Accordion" model="commercialToolStatusAccordion"/>
                    <partial name="_Accordion" model="contractingAuthorityUsageAccordion"/>
                    <partial name="_Accordion" model="awardMethodAccordion"/>
                    <partial name="_Accordion" model="industryCpvCodeAccordion"/>
                    <partial name="_Accordion" model="contractLocationAccordion"/>
                    <partial name="_Accordion" model="feesAccordion"/>
                    <partial name="_Accordion" model="dateRangeAccordion"/>
                </div>

                <div class="govuk-button-group govuk-!-margin-top-4">
                    <button type="submit" class="govuk-button" data-module="govuk-button">
                        Update results
                    </button>
                    <a href="/" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="reset-filters">
                        Reset
                    </a>
                </div>
            </form>
        </div>
        <div class="govuk-grid-column-two-thirds">
            @if (Model.SearchResults.Any())
            {
                <ul class="govuk-list">
                    @foreach (var result in Model.SearchResults)
                    {
                        <li>
                            <partial name="Shared/_SearchResult" model="result"/>
                        </li>
                    }
                </ul>

                <partial name="Shared/_Pagination" model="Model.Pagination"/>
            }
            else
            {
                <div class="govuk-grid-column-one-half govuk-!-margin-left-auto govuk-!-margin-right-auto">
                    <p class="govuk-body govuk-!-font-size-19 govuk-!-font-weight-bold">No results found.</p>
                    <p class="govuk-body">Try:</p>
                    <ul class="govuk-list govuk-list--bullet">
                        <li>checking your spelling</li>
                        <li>using fewer keywords</li>
                        <li>using different search terms</li>
                        <li>removing some filters</li>
                    </ul>
                </div>
            }
        </div>
    </div>